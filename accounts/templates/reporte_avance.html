{# templates/reporte_avances.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Reporte de Avance | KLAIM{% endblock %}
{% block body_class %}reporte-avance-page{% endblock %}

{# ——— CSS exclusivo de la vista ——— #}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/pages/reporte_avances.css' %}">
{% endblock %}

{# ——— CONTENIDO ——— #}
{% block content %}



<div class="main-container animate-fade">
  <!-- Dashboard Header -->
  <header class="dashboard-header animate-slide">
    <h1>Reporte de Avance</h1>
    <p>Generado: {{ hoy|date:"d /m /Y – H:i" }}</p>
  </header>

  <!-- KPIs -->
  <section class="kpis-section animate-slide">
    <div class="kpis-grid">
      <div class="kpi-card"><h3>Obras</h3><div class="kpi-value">{{ totales.obras }}</div></div>
      <div class="kpi-card"><h3>ISRC</h3><div class="kpi-value">{{ totales.isrc }}</div></div>
      <div class="kpi-card"><h3>Conflictos</h3><div class="kpi-value">{{ totales.conflictos }}</div></div>
      <div class="kpi-card"><h3>Matching-ISRC</h3><div class="kpi-value">{{ totales.matching_isrc }}</div></div>
      <div class="kpi-card"><h3>Matching T/A</h3><div class="kpi-value">{{ totales.matching_ta }}</div></div>
      <div class="kpi-card"><h3>Audios</h3><div class="kpi-value">{{ totales.audio_links }}</div></div>
    </div>
  </section>

  <!-- Botones -->
  <div class="buttons-section animate-slide">
    <button id="btnDownloadScreen" class="download-btn" type="button" title="Descargar lo que ves">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
           stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      PDF de pantalla
    </button>

    <a href="{% url 'generar_reporte_pdf' %}" target="_blank"
       class="download-btn" title="Generado por ReportLab">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
           stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
        <line x1="16" y1="13" x2="8" y2="13"/>
        <line x1="16" y1="17" x2="8" y2="17"/>
        <polyline points="10 9 9 9 8 9"/>
      </svg>
      PDF detallado
    </a>
  </div>

  <!-- Gráficas -->
  <section id="charts" class="charts-section animate-slide"></section>

  <!-- Tabla -->
  <section class="table-section animate-slide">
    <table class="data-table">
      <thead>
        <tr>
          <th>Cliente</th><th>Obras</th><th>ISRC</th><th>Conflictos</th>
          <th>Matching-ISRC</th><th>Matching T/A</th><th>Audios</th>
        </tr>
      </thead>
      <tbody>
        {% for row in clientes %}
        <tr>
          <td style="text-align:left">{{ row.cliente }}</td>
          <td>{{ row.obras }}</td><td>{{ row.isrc }}</td><td>{{ row.conflictos }}</td>
          <td>{{ row.matching_isrc }}</td><td>{{ row.matching_ta }}</td><td>{{ row.audio_links }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="7" class="empty-state">No hay datos disponibles</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
</div>

{% endblock %}

{# ——— SCRIPTS ——— #}
{% block scripts %}
<script>
  /* JSON para gráficas -------------------------------------------------- */
  const rows = JSON.parse('{{ clientes|safe|escapejs }}'.replace(/'/g,'"')||'[]');
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="{% static 'js/reporte_avances.js' %}" defer></script>
{% endblock %}
