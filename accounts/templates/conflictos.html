{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Claims | KLAIM{% endblock %}

{% block body_class %}conflicts-page{% endblock %}

{% block extra_css %}
  <!-- Hoja específica de la página (los globales ya vienen en base) -->
  <link rel="stylesheet" href="{% static 'css/pages/conflictos.css' %}">
{% endblock %}

{% block content %}
<div class="main-container">
<!-- Modal Estado para conflictos -->
<!-- CORRECTO -->
<div id="modal-estado" class="modal-overlay">
  <div class="modal-container">
    <button class="modal-close" onclick="closeModalEstado()" aria-label="Close modal">&times;</button>
    <h2 class="modal-title">Modify Platform Status</h2>

    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

    <select id="estado-select" class="modal-select" aria-label="Select new status">
      <option value="OK">OK</option>
      <option value="LIBERADA">LIBERADA</option>
    </select>

    <button class="modal-button" onclick="submitEstadoConflicto()">CONFIRM&nbsp;UPDATE</button>
  </div>
</div>

  {# ----------  FORMULARIO PRINCIPAL  ---------- #}
  <div class="conflict-form-container">
    <div class="form-header">
      <h2><i class="icon-alert"></i> Manage Claims</h2>
      <p>Complete the information to register or update a claim</p>
    </div>

    <div class="form-grid">
      <div class="input-group">
        <label for="nombre-contraparte"><i class="icon-user"></i> Counterparty's name</label>
        <div class="input-wrapper">
          <i class="icon-user input-icon"></i>
          <input type="text" id="nombre-contraparte" class="form-control" placeholder="Enter counterparty name">
        </div>
      </div>

      <div class="input-group">
        <label for="porcentaje-contraparte"><i class="icon-percent"></i> Counterparty's shares</label>
        <div class="input-wrapper">
          <input type="number" id="porcentaje-contraparte" class="form-control" placeholder="0.00" step="0.01">
          <span class="input-suffix">%</span>
        </div>
      </div>
    </div>

    <div class="input-group full-width">
      <label for="informacion-adicional"><i class="icon-notes"></i> Actions Taken</label>
      <div class="textarea-wrapper">
        <textarea id="informacion-adicional" class="form-textarea" placeholder="Describe the actions taken..."></textarea>
        <div class="textarea-footer"><span class="char-counter">0/500</span></div>
      </div>
    </div>

    <div class="form-actions">
      <button class="btn btn--danger" onclick="eliminarConflicto()"><i class="icon-delete"></i> Delete Claim</button>
      <button class="btn btn--success" onclick="actualizarConflicto()"><i class="icon-add"></i> Create Claim</button>
      <button class="btn btn--primary" onclick="insertarInformacionConflicto()"><i class="icon-update"></i> Update Claim</button>
    </div>
  </div>

  {# ----------  TABLA MLC  ---------- #}
  <h2 class="section-title">Overclaim works MLC</h2>
  <section class="table-section">
    <div class="table-responsive">
      <form id="conflictos-mlc-form">
        <table class="data-table">
          <thead>
            <tr>
              <th class="select-col">Select</th>
              <th>Title</th>
              <th>SGS</th>
              <th>ISWC</th>
              <th>Authors</th>
              <th>Share</th>
              <th>Client</th>
              <th>Cod MLC</th>
              <th>Counterparty</th>
              <th>Share Counterparty</th>
              <th>Additional information</th>
            </tr>
          </thead>
          <tbody>
            {% for obra in conflictos_mlc %}
            <tr>
              <td class="select-col"><input type="checkbox" name="obras" value="{{ obra.cod_klaim }}"></td>
              <td>{{ obra.titulo }}</td>
              <td>{{ obra.codigo_sgs }}</td>
              <td>{{ obra.codigo_iswc }}</td>
              <td>
                {% if obra.obrasautores_set.all %}
                  <div class="dot-list">
                    {% for oa in obra.obrasautores_set.all %}
                      <span class="nl-item" title="{{ oa.autor.nombre_autor }}">
                        {{ oa.autor.nombre_autor }}
                      </span>
                    {% endfor %}
                  </div>
                {% else %}-{% endif %}
              </td>

              <td>
                {% for oa in obra.obrasautores_set.all %}
                  {{ oa.porcentaje_autor }}%<br>
                {% endfor %}
              </td>
              <td>{{ obra.catalogo.cliente.nombre_cliente }}</td>
              <td>{{ obra.subidasplataforma_set.first.codigo_MLC|default:"N/A" }}</td>

              {% with c=obra.conflictos.last %}
                {% if c and c.estado_conflicto == 'vigente' %}
                  <td>{{ c.nombre_contraparte|default:"N/A" }}</td>
                  <td>{{ c.porcentaje_contraparte|default:"N/A" }}</td>
                  <td>{{ c.informacion_adicional|default:"N/A" }}</td>
                {% else %}
                  <td>N/A</td><td>N/A</td><td>N/A</td>
                {% endif %}
              {% endwith %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </form>
    </div>

    {# ---------- PAGINACIÓN MLC ---------- #}
    <div class="pagination" role="navigation" aria-label="Pagination MLC">
      {% if page_obj_mlc.has_previous %}
        <a href="?page_mlc=1{% if page_obj_adrev.number %}&page_adrev={{ page_obj_adrev.number }}{% endif %}">&laquo;</a>
        <a href="?page_mlc={{ page_obj_mlc.previous_page_number }}{% if page_obj_adrev.number %}&page_adrev={{ page_obj_adrev.number }}{% endif %}">Anterior</a>
      {% endif %}

      <span class="current">Page {{ page_obj_mlc.number }} of {{ page_obj_mlc.paginator.num_pages }}</span>

      {% if page_obj_mlc.has_next %}
        <a href="?page_mlc={{ page_obj_mlc.next_page_number }}{% if page_obj_adrev.number %}&page_adrev={{ page_obj_adrev.number }}{% endif %}">Siguiente</a>
        <a href="?page_mlc={{ page_obj_mlc.paginator.num_pages }}{% if page_obj_adrev.number %}&page_adrev={{ page_obj_adrev.number }}{% endif %}">&raquo;</a>
      {% endif %}
    </div>
  </section>

  {# ----------  TABLA ADREV  ---------- #}
  <h2 class="section-title">Overclaim works ADREV</h2>
  <section class="table-section">
    <div class="table-responsive">
      <form id="conflictos-adrev-form">
        <table class="data-table">
          <thead>
            <tr>
              <th class="select-col">Select</th>
              <th>Title</th>
              <th>SGS</th>
              <th>ISWC</th>
              <th>Authors</th>
              <th>Share</th>
              <th>Client</th>
              <th>Cod ADREV</th>
              <th>Counterparty</th>
              <th>Share Counterparty</th>
              <th>Additional information</th>
            </tr>
          </thead>
          <tbody>
            {% for obra in conflictos_adrev %}
            <tr>
              <td class="select-col"><input type="checkbox" name="obras" value="{{ obra.cod_klaim }}"></td>
              <td>{{ obra.titulo }}</td>
              <td>{{ obra.codigo_sgs }}</td>
              <td>{{ obra.codigo_iswc }}</td>
              <td>
                {% if obra.obrasautores_set.all %}
                  <div class="dot-list">
                    {% for oa in obra.obrasautores_set.all %}
                      <span class="nl-item" title="{{ oa.autor.nombre_autor }}">
                        {{ oa.autor.nombre_autor }}
                      </span>
                    {% endfor %}
                  </div>
                {% else %}-{% endif %}
              </td>

              <td>
                {% for oa in obra.obrasautores_set.all %}
                  {{ oa.porcentaje_autor }}%<br>
                {% endfor %}
              </td>
              <td>{{ obra.catalogo.cliente.nombre_cliente }}</td>
              <td>{{ obra.subidasplataforma_set.first.codigo_ADREV|default:"N/A" }}</td>

              {% with c=obra.conflictos.last %}
                {% if c and c.estado_conflicto == 'vigente' %}
                  <td>{{ c.nombre_contraparte|default:"N/A" }}</td>
                  <td>{{ c.porcentaje_contraparte|default:"N/A" }}</td>
                  <td>{{ c.informacion_adicional|default:"N/A" }}</td>
                {% else %}
                  <td>N/A</td><td>N/A</td><td>N/A</td>
                {% endif %}
              {% endwith %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </form>
    </div>

    {# ---------- PAGINACIÓN ADREV ---------- #}
    <div class="pagination" role="navigation" aria-label="Pagination ADREV">
      {% if page_obj_adrev.has_previous %}
        <a href="?page_adrev=1{% if page_obj_mlc.number %}&page_mlc={{ page_obj_mlc.number }}{% endif %}">&laquo;</a>
        <a href="?page_adrev={{ page_obj_adrev.previous_page_number }}{% if page_obj_mlc.number %}&page_mlc={{ page_obj_mlc.number }}{% endif %}">Anterior</a>
      {% endif %}

      <span class="current">Page {{ page_obj_adrev.number }} of {{ page_obj_adrev.paginator.num_pages }}</span>

      {% if page_obj_adrev.has_next %}
        <a href="?page_adrev={{ page_obj_adrev.next_page_number }}{% if page_obj_mlc.number %}&page_mlc={{ page_obj_mlc.number }}{% endif %}">Siguiente</a>
        <a href="?page_adrev={{ page_obj_adrev.paginator.num_pages }}{% if page_obj_mlc.number %}&page_mlc={{ page_obj_mlc.number }}{% endif %}">&raquo;</a>
      {% endif %}
    </div>
  </section>

</div>
{% endblock %}

{% block scripts %}
  <script>
    const URL_ELIMINAR_CONFLICTO   = "{% url 'eliminar_conflicto' %}";
    const URL_UPDATE_ESTADO_OBRA   = "{% url 'actualizar_estado_obra' %}";
  </script>
  <script src="{% static 'js/conflictos.js' %}"></script>
  <script src="{% static 'js/modals.js' %}"></script>
{% endblock %}
