{% extends 'base.html' %}
{% load static %}

{% block title %}Music Works Catalog | KLAIM{% endblock %}

{% block body_class %}catalog-page{% endblock %}

{% block extra_css %}
  <!-- Fuentes (si las usas en base.css o similares) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Base y estructura -->
  <link rel="stylesheet" href="{% static 'css/base.css' %}">

  <!-- Página catálogo -->
  <link rel="stylesheet" href="{% static 'css/pages/catalogo.css' %}">
  <link rel="stylesheet" href="{% static 'css/pages/index.css' %}">

  <!-- Componentes reutilizables -->
  <link rel="stylesheet" href="{% static 'css/components/tables.css' %}">
  <link rel="stylesheet" href="{% static 'css/components/button.css' %}">
  <link rel="stylesheet" href="{% static 'css/components/alert.css' %}">
{% endblock %}

{% block content %}
<div class="main-container animate-fade">

  <!-- Sección de Búsqueda -->
  <section class="search-section animate-slide">
    <h1 class="search-title">Music Works Catalog</h1>
    <form method="get">
      <div class="search-grid">
        <div class="search-input-group">
          <span class="search-label">Title</span>
          <input type="text" name="titulo" class="search-input" placeholder="Search by Title..." value="{{ request.GET.titulo }}">
        </div>

        <div class="search-input-group">
          <span class="search-label">SGS Code</span>
          <input type="text" name="codigo_sgs" class="search-input" placeholder="Search by SGS Code..." value="{{ request.GET.codigo_sgs }}">
        </div>

        <div class="search-input-group">
          <span class="search-label">ISWC Code</span>
          <input type="text" name="codigo_iswc" class="search-input" placeholder="Search by ISWC Code..." value="{{ request.GET.codigo_iswc }}">
        </div>

        <div class="search-input-group">
          <span class="search-label">Author</span>
          <input type="text" name="autor" class="search-input" placeholder="Search by Author..." value="{{ request.GET.autor }}">
        </div>

        <div class="search-input-group">
          <span class="search-label">Catalog ID</span>
          <input type="text" name="id_catalogo" class="search-input" placeholder="Search by Catalog ID..." value="{{ request.GET.id_catalogo }}">
        </div>

        <div class="search-input-group">
          <span class="search-label">Klaim Code</span>
          <input type="text" name="codigo_klaim" class="search-input" placeholder="Search by Klaim Code..." value="{{ request.GET.codigo_klaim }}">
        </div>
      </div>

      <div class="checkbox-container">
        <label class="checkbox-label">
          Include released works
          <input type="checkbox" id="incluir_liberadas" name="incluir_liberadas" {% if incluir_liberadas == 'on' %}checked{% endif %}>
          <span class="checkmark"></span>
        </label>
      </div>

      <button type="submit" class="search-button">Search Works</button>
    </form>
  </section>

  <!-- Tabla -->
  <section class="table-section animate-slide">
    <div class="table-responsive">
      <table class="data-table">
        <thead>
          <tr>
            <th>Klaim</th>
            <th>Title</th>
            <th>SGS</th>
            <th>ISWC</th>
            <th>Authors</th>
            <th>Share</th>
            <th>Artists</th>
            <th>Client</th>
            <th>MLC Code</th>
            <th>ADREV Code</th>
            <th>MLC Status</th>
            <th>ADREV Status</th>
          </tr>
        </thead>
        <tbody>
          {% for obra in obras %}
          <tr>
            <td>{{ obra.cod_klaim }}</td>
            <td>{{ obra.titulo }}</td>
            <td>{{ obra.codigo_sgs }}</td>
            <td>{{ obra.codigo_iswc }}</td>
            <td>
              {% if obra.autores_prefetched %}
                <div class="dot-list">
                  {% for autor in obra.autores_prefetched %}
                    <span class="nl-item" title="{{ autor.autor.nombre_autor }}">
                      {{ autor.autor.nombre_autor }}
                    </span>
                  {% endfor %}
                </div>
              {% else %}-{% endif %}
            </td>

            <td>
              {% for autor in obra.autores_prefetched %}
                {{ autor.porcentaje_autor }}%<br>
              {% endfor %}
            </td>
            <td>
              {% if obra.artistas_prefetched %}
                {% for artista in obra.artistas_prefetched %}
                  {{ artista.artista_unico.nombre_artista }}{% if not forloop.last %}; {% endif %}
                {% endfor %}
              {% else %}-{% endif %}
            </td>
            <td>{{ obra.catalogo.cliente.nombre_cliente }}</td>
            <td>{{ obra.subidasplataforma_set.first.codigo_MLC }}</td>
            <td>{{ obra.subidasplataforma_set.first.codigo_ADREV }}</td>
            <td class="status-cell" onclick="openModal('{{ obra.cod_klaim }}', 'estado_MLC')">
              {% with status=obra.subidasplataforma_set.first.estado_MLC %}
                {% if status %}
                  <span class="status-badge status-{% if status == 'OK' %}ok{% elif status == 'Conflicto' %}conflicto{% elif status == 'NO CARGADA' %}no-cargada{% elif status == 'LIBERADA' %}liberada{% endif %}">
                    {{ status }}
                  </span>
                {% else %}-{% endif %}
              {% endwith %}
            </td>
            <td class="status-cell" onclick="openModal('{{ obra.cod_klaim }}', 'estado_ADREV')">
              {% with status=obra.subidasplataforma_set.first.estado_ADREV %}
                {% if status %}
                  <span class="status-badge status-{% if status == 'OK' %}ok{% elif status == 'Conflicto' %}conflicto{% elif status == 'NO CARGADA' %}no-cargada{% elif status == 'LIBERADA' %}liberada{% endif %}">
                    {{ status }}
                  </span>
                {% else %}-{% endif %}
              {% endwith %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
        <div class="pagination" role="navigation" aria-label="Pagination">
            {% if page_obj.has_previous %}
            <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page=1" aria-label="First page">&laquo;</a>
            <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.previous_page_number }}" aria-label="Previous page">Anterior</a>
            {% endif %}

            <span class="current" aria-current="page">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

            {% if page_obj.has_next %}
            <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.next_page_number }}" aria-label="Next page">Siguiente</a>
            <a href="?{% if request.GET %}{{ request.GET.urlencode }}&{% endif %}page={{ page_obj.paginator.num_pages }}" aria-label="Last page">&raquo;</a>
            {% endif %}
        </div>
    </div>
  </section>



  <!-- Modal -->
  <!-- Modal -->
  <div id="modal" class="modal-overlay">
      <div class="modal-container">
      <div class="modal-header">
        <h2 class="modal-title">Update Status</h2>
        <button class="modal-close" onclick="closeModal()" aria-label="Close modal">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <!-- CSRF token oculto para JS -->
      <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

      <select id="estado-select" class="modal-select" aria-label="Select status">
        <option value="OK">OK</option>
        <option value="Conflicto">CLAIM</option>
        <option value="NO CARGADA">NOT ID</option>
        <option value="LIBERADA">REMOVE WORK</option>
      </select>

      <button class="modal-button" onclick="submitEstado()">
        CONFIRM UPDATE
      </button>
    </div>
  </div>


</div>
{% endblock %}

{% block scripts %}
  <script src="{% static 'js/index.js' %}"></script>
  <script src="{% static 'js/modals.js' %}"></script>
{% endblock %}
